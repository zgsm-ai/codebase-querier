# Codebase Querier 工程需求分析文档

## 1. 项目概述

### 1.1 项目名称
Codebase Querier - 代码库查询和智能HTTP代理服务

### 1.2 项目背景
基于Go-zero框架开发的代码库分析和智能HTTP反向代理服务，主要用于：
- 代码库的语义搜索和结构分析
- 智能HTTP请求转发和代理
- 动态端口管理和路由选择
- 多种转发策略的统一管理

### 1.3 技术栈
- **框架**: Go-zero v1.8.3
- **语言**: Go 1.24.3
- **配置**: YAML配置文件
- **部署**: Docker + Kubernetes
- **监控**: Prometheus集成
- **日志**: go-zero内置日志系统

## 2. 核心功能需求

### 2.1 代码库分析功能

#### 2.1.1 代码关系查询
- **功能描述**: 提供代码符号的引用关系树查询
- **接口**: `GET /codebase-indexer/api/v1/search/relation`
- **核心参数**:
  - clientId: 用户机器ID
  - codebasePath: 项目绝对路径
  - filePath: 文件相对路径
  - startLine/endLine: 代码行范围
  - symbolName: 符号名称
- **返回内容**: 符号定义和引用关系的层级结构

#### 2.1.2 语义搜索
- **功能描述**: 基于自然语言的代码语义搜索
- **接口**: `GET /codebase-indexer/api/v1/search/semantic`
- **搜索能力**:
  - 支持自然语言查询
  - 代码片段匹配
  - 语义相似度排序

#### 2.1.3 文件结构分析
- **功能描述**: 获取文件的结构信息（类、函数、变量等）
- **接口**: `GET /codebase-indexer/api/v1/file/structure`
- **分析内容**:
  - 类定义和方法
  - 函数签名
  - 变量声明
  - 代码位置信息

#### 2.1.4 代码库管理
- **目录树查询**: `GET /codebase-indexer/api/v1/codebases/directory`
- **文件内容获取**: `GET /codebase-indexer/api/v1/files/content`
- **哈希值计算**: `GET /codebase-indexer/api/v1/codebases/hash`
- **索引管理**: 创建、删除、更新代码库索引

### 2.2 智能HTTP代理功能

#### 2.2.1 智能路由选择
- **功能描述**: 根据请求头和配置自动选择最优转发策略
- **核心逻辑**:
  1. 检查`X-Costrict-Version`请求头 → 动态端口转发
  2. 检查配置的固定转发地址 → 静态地址转发
  3. 基于请求头的条件转发
  4. 默认端口管理器转发

#### 2.2.2 动态端口管理
- **功能描述**: 通过端口管理器动态获取目标服务端口
- **实现方式**:
  - **多种clientId获取方式**:
    - GET请求：从URL查询参数中获取clientId
    - 其他请求：从请求体JSON中获取clientId
    - 兜底方案：从请求头中获取clientId（向后兼容）
  - **原始请求头透传**: 完整保留并转发原始接口请求的所有header（除内部使用的clientId、appName等）
  - **端口信息获取**: 调用端口管理器API获取目标服务端口
  - **动态URL构建**: 基于获取的端口信息构建最终转发地址
  - **缓存机制**: 支持端口信息缓存（默认5分钟过期）
  - **查询参数保持**: 完整保留原始请求的查询参数

#### 2.2.3 多种转发策略

##### 静态代理转发
- 固定目标地址转发
- 支持路径重写规则
- Header过滤和覆盖

##### 动态代理转发
- 基于端口管理器的动态转发
- 支持多种clientId获取方式
- 自动端口发现和缓存

##### 基于请求头的转发
- 根据特定请求头存在与否选择不同转发地址
- 支持多路径配置
- 灵活的条件转发规则

#### 2.2.4 全路径转发模式
- **功能描述**: 将完整请求路径原样转发到目标服务
- **特性**:
  - 保留原始URL结构
  - 保留查询参数
  - 支持多级路径
  - 特殊字符编码保持

### 2.3 配置管理功能

#### 2.3.1 代理配置
```yaml
proxy_config:
  mode: "full_path"              # 代理模式
  port_manager_url: "http://127.0.0.1:31226"
  forward_url: "http://target-service"  # 固定转发地址
  dynamic_port: true             # 启用动态端口
  routes:                        # 路由规则数组
    - path_prefix: "/api/v1/proxy"
      target:
        url: "http://localhost:8080"
        timeout: 30s
```

#### 2.3.2 基于请求头的转发配置
```yaml
header_based_forward:
  enabled: true
  header_name: "X-Custom-Header"
  paths:
    - path: "/api/special"
      with_header_url: "http://service-a:8080"
      without_header_url: "http://service-b:8080"
```

## 3. 非功能性需求

### 3.1 性能需求
- **响应时间**: 本地查询 < 100ms，代理转发 < 1s
- **并发支持**: 支持100+并发请求
- **超时控制**: 可配置请求超时时间（默认30s）
- **连接池**: HTTP连接复用，提升性能

### 3.2 可靠性需求
- **健康检查**: 代理服务和目标服务的健康状态监控
- **错误处理**: 统一的错误响应格式
- **故障恢复**: 目标服务不可达时的优雅降级
- **日志记录**: 完整的请求转发日志

### 3.3 安全需求
- **Header过滤**: 支持敏感Header的过滤和覆盖
- **路径验证**: 防止目录遍历攻击
- **用户隔离**: 基于clientId的用户数据隔离
- **HTTPS支持**: 支持HTTPS目标地址

### 3.4 扩展性需求
- **插件架构**: 支持自定义代理策略
- **多语言支持**: 代码分析支持多种编程语言
- **配置热更新**: 支持运行时配置更新
- **监控集成**: Prometheus指标收集

## 4. 部署和运维需求

### 4.1 容器化部署
- Docker镜像构建
- Kubernetes部署配置
- 服务发现和负载均衡
- 配置文件管理

### 4.2 监控和日志
- Prometheus指标暴露
- 结构化日志输出
- 健康检查端点
- 性能指标收集

### 4.3 配置管理
- YAML配置文件
- 环境变量覆盖
- 配置验证机制
- 默认配置提供

## 5. API接口规范

### 5.1 统一响应格式
```json
{
  "code": "SUCCESS",
  "message": "操作成功",
  "data": {},
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### 5.2 错误处理
```json
{
  "code": "ERROR_CODE",
  "message": "错误描述",
  "details": "详细错误信息",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### 5.3 通用参数
- `clientId`: 用户机器ID，用于用户隔离
- `codebasePath`: 项目绝对路径
- `filePath`: 文件相对路径

## 6. 技术架构

### 6.1 整体架构
```
客户端 → 负载均衡 → 智能代理服务 → 目标服务
                    ↓
                端口管理器
                    ↓
                 缓存层
```

### 6.2 核心组件
- **SmartProxyHandler**: 智能路由选择器
- **DynamicProxyHandler**: 动态端口代理处理器
- **StaticProxyHandler**: 静态地址代理处理器
- **PortManager**: 端口管理器
- **ConfigManager**: 配置管理器

### 6.3 数据流
1. 请求接收和解析
2. 路由策略选择
3. 目标地址构建
4. 请求转发
5. 响应处理和返回

## 7. 开发和测试需求

### 7.1 开发环境
- Go 1.24.3+
- go-zero框架
- Docker开发环境
- 代码质量检查工具

### 7.2 测试需求
- 单元测试覆盖率 > 80%
- 集成测试
- 性能测试
- 安全测试

### 7.3 文档需求
- API接口文档
- 部署指南
- 配置说明
- 故障排查手册

## 8. 项目交付物

### 8.1 代码交付
- 完整的Go源代码
- Docker镜像
- Kubernetes部署文件
- 配置文件模板

### 8.2 文档交付
- 技术设计文档
- API接口文档
- 部署和运维手册
- 用户使用指南

### 8.3 测试交付
- 单元测试代码
- 集成测试用例
- 性能测试报告
- 安全测试报告

---

**文档版本**: 1.0  
**创建日期**: 2024年12月  
**最后更新**: 2024年12月  
**文档状态**: 基于代码反推生成