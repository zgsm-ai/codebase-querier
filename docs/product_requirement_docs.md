# HTTP协议转发功能需求规格说明书

## 1. 项目概述

### 1.1 背景
当前Codebase Querier项目需要增加HTTP协议转发功能，以支持将接收到的HTTP请求转发到指定的目标服务，并将响应返回给原始请求方。

### 1.2 目标
构建一个轻量级、高性能的HTTP反向代理功能，支持基本的请求转发、响应透传和错误处理。

### 1.3 范围
MVP版本将专注于核心转发功能，不包含负载均衡、缓存、限流等高级特性。

## 2. 需求规格（EARS语法）

### 2.1 功能性需求

#### 2.1.1 请求接收需求
**EARS语法描述：**
- **Ubiquitous**: 当系统启动时，**应该**监听配置的端口并接收HTTP请求
- **Event-driven**: 当接收到HTTP请求时，**必须**解析请求方法、路径、Header和Body
- **State-driven**: 如果请求格式有效，**应该**准备转发到目标地址
- **Unwanted behavior**: 如果请求格式无效，**必须**返回400 Bad Request错误

#### 2.1.2 目标地址配置需求
**EARS语法描述：**
- **Ubiquitous**: 系统**必须**从配置文件读取目标服务地址
- **State-driven**: 如果配置文件中的目标地址格式无效，**必须**在启动时报错并退出
- **Optional**: 系统**可以**支持通过环境变量覆盖配置文件中的目标地址

#### 2.1.3 请求转发需求
**EARS语法描述：**
- **Event-driven**: 当接收到有效HTTP请求时，**必须**将请求转发到配置的目标地址
- **Ubiquitous**: 转发时**必须**保留原始请求的方法、路径和查询参数
- **State-driven**: 如果目标地址不可达，**必须**返回503 Service Unavailable错误
- **Complex**: 当转发请求时，**应该**：
  - 替换Host Header为目标地址
  - 保留其他所有Header（除Connection相关Header）
  - 保留原始请求Body内容

#### 2.1.4 响应处理需求
**EARS语法描述：**
- **Event-driven**: 当收到目标服务响应时，**必须**将响应原样返回给原始请求方
- **Ubiquitous**: 响应**必须**包含：
  - 原始状态码
  - 原始响应Header
  - 原始响应Body
- **State-driven**: 如果响应超时，**必须**返回504 Gateway Timeout错误

#### 2.1.5 路径重写需求
**EARS语法描述：**
- **Optional**: 系统**可以**支持基于配置的路径重写规则
- **Complex**: 当配置了路径重写规则时，**应该**：
  - 支持前缀匹配和替换
  - 支持正则表达式匹配和替换
  - 在转发前应用重写规则

#### 2.1.6 全路径转发需求（新增）
**EARS语法描述：**
- **Ubiquitous**: 系统**必须**支持将所有接收到的请求路径（包括根路径"/"和所有子路径）原样转发到目标服务
- **Event-driven**: 当接收到任何HTTP请求时，**必须**将完整路径（包括查询参数）附加到目标服务地址后形成最终转发URL
- **State-driven**: 如果配置了全路径转发模式，**必须**禁用路径重写功能以避免冲突
- **Complex**: 当启用全路径转发时，**应该**：
  - 保留原始URL的完整路径结构
  - 保留所有查询参数
  - 保留路径中的特殊字符编码
  - 支持多级路径转发（如"/api/v1/users/123"）

#### 2.1.7 错误处理需求
**EARS语法描述：**
- **Event-driven**: 当发生任何错误时，**必须**返回统一的JSON格式错误响应
- **Ubiquitous**: 错误响应**必须**包含：
  - code: 自定义错误码
  - message: 错误描述
  - details: 详细错误信息
  - timestamp: 错误发生时间

### 2.2 非功能性需求

#### 2.2.1 性能需求
**EARS语法描述：**
- **Ubiquitous**: 系统**必须**在30秒内完成请求转发（可配置）
- **State-driven**: 当并发请求达到100时，**应该**保持响应时间在1秒以内

#### 2.2.2 兼容性需求
**EARS语法描述：**
- **Ubiquitous**: 系统**必须**支持HTTP/1.1协议
- **Optional**: 系统**可以**支持HTTP/2协议
- **Ubiquitous**: 系统**必须**支持以下HTTP方法：
  - GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS

#### 2.2.3 安全需求
**EARS语法描述：**
- **Ubiquitous**: 系统**必须**支持配置Header过滤规则
- **Optional**: 系统**可以**支持敏感Header（如Authorization）的传递控制
- **State-driven**: 如果配置了Header过滤，**必须**在转发前移除指定Header

#### 2.2.4 可靠性需求
**EARS语法描述：**
- **Ubiquitous**: 系统**必须**在启动时验证目标地址的可达性
- **Event-driven**: 当目标服务不可用时，**应该**提供有意义的错误信息
- **State-driven**: 如果配置无效，**必须**拒绝启动并提供详细错误说明

## 3. 用户故事

### 3.1 作为API开发者
**作为** API开发者  
**我想要** 将我的API请求转发到后端服务  
**以便于** 在开发环境中调试和测试API

**验收条件**：
- 可以配置目标服务地址
- 可以查看转发日志
- 可以处理各种HTTP方法

### 3.2 作为系统管理员
**作为** 系统管理员  
**我想要** 通过配置文件管理转发规则  
**以便于** 无需修改代码即可调整转发行为

**验收条件**：
- 配置变更后服务可热加载
- 配置错误有明确的错误提示
- 支持环境变量覆盖配置

### 3.3 作为全栈开发者（新增）
**作为** 全栈开发者  
**我想要** 将所有前端请求无缝转发到后端API服务  
**以便于** 解决开发环境中的跨域问题并保持API路径一致性

**验收条件**：
- 支持任意路径的转发
- 保持原始URL结构不变
- 支持多级路径和查询参数

## 4. 数据需求

### 4.1 配置数据结构
```yaml
proxy:
  target:
    url: "http://target-service:8080"
    timeout: 30s
  rewrite:
    enabled: true
    rules:
      - from: "/api/v1/proxy"
        to: ""
  headers:
    pass_through: true
    exclude:
      - "X-Internal-*"
    override:
      Host: "target-service"
```

### 4.2 全路径转发配置（新增）
```yaml
proxy:
  mode: "full_path"  # 新增：支持"rewrite"和"full_path"两种模式
  target:
    url: "http://target-service:8080"
    timeout: 30s
  headers:
    pass_through: true
    exclude:
      - "X-Internal-*"
```

### 4.3 错误响应格式
```json
{
  "code": "PROXY_ERROR",
  "message": "Failed to forward request",
  "details": "connection timeout to target service",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

## 5. 接口需求

### 5.1 转发接口
- **路径**: 所有以 `/proxy/*` 开头的请求
- **方法**: 支持所有HTTP方法
- **描述**: 将请求转发到配置的目标地址

### 5.2 全路径转发接口（新增）
- **路径**: 所有请求路径（包括根路径"/"和所有子路径）
- **方法**: 支持所有HTTP方法
- **描述**: 将任何接收到的请求路径原样转发到目标服务

### 5.3 健康检查接口
- **路径**: `/health`
- **方法**: GET
- **描述**: 检查代理服务和目标服务的健康状态

## 6. 约束条件

### 6.1 技术约束
- 基于现有Go代码库开发
- 使用go-zero框架
- 保持与现有API的兼容性

### 6.2 业务约束
- MVP版本不支持WebSocket
- 不支持文件上传的特殊处理
- 不支持响应内容修改

### 6.3 全路径转发约束（新增）
- 全路径转发模式下不支持路径重写功能
- 必须确保目标服务能够处理所有接收到的路径
- 不支持路径前缀的自动移除

## 7. 假设和依赖

### 7.1 假设
- 目标服务始终可用HTTP协议
- 网络环境稳定
- 请求和响应大小在合理范围内（<10MB）

### 7.2 依赖
- 依赖go-zero框架的HTTP服务器功能
- 依赖标准库的net/http包进行转发

## 8. 风险分析

| 风险描述 | 概率 | 影响 | 缓解策略 |
|----------|------|------|----------|
| 目标服务不可用 | 中 | 高 | 提供清晰的错误信息和重试机制 |
| 配置错误导致转发失败 | 低 | 中 | 启动时验证配置有效性 |
| 大文件传输超时 | 中 | 中 | 提供可配置的超时时间 |
| Header处理不当导致安全问题 | 低 | 高 | 提供Header过滤配置 |
| 全路径转发导致路径冲突 | 中 | 中 | 提供模式切换配置，避免与现有路径冲突 |

## 9. 验收标准

### 9.1 功能验收
- [ ] 能够正确转发GET请求
- [ ] 能够正确转发POST请求（包含Body）
- [ ] 能够正确处理响应状态码
- [ ] 能够正确传递响应Header
- [ ] 能够正确处理超时情况
- [ ] 能够正确应用路径重写规则
- [ ] 能够正确实现全路径转发（新增）
- [ ] 能够正确处理多级路径转发（新增）
- [ ] 能够正确处理查询参数（新增）

### 9.2 性能验收
- [ ] 单请求响应时间 < 100ms（本地网络）
- [ ] 并发100请求成功率 > 99%
- [ ] 内存使用稳定，无明显泄漏

### 9.3 安全验收
- [ ] 敏感Header可配置过滤
- [ ] 错误信息不暴露内部实现细节
- [ ] 支持HTTPS目标地址

### 9.4 全路径转发验收（新增）
- [ ] 根路径"/"能够正确转发
- [ ] 多级路径如"/api/v1/users/123"能够正确转发
- [ ] 查询参数如"?page=1&size=10"能够正确传递
- [ ] 特殊字符编码能够正确处理
- [ ] 与现有路径重写功能无冲突

## 10. 后续版本规划

### 10.1 V2版本
- 支持WebSocket转发
- 支持负载均衡
- 支持请求/响应日志记录
- 支持基本认证

### 10.2 V3版本
- 支持缓存机制
- 支持限流功能
- 支持响应内容修改
- 支持Web界面配置

### 10.3 全路径转发增强（新增）
- 支持基于路径前缀的路由选择
- 支持多个目标服务的动态切换
- 支持路径模板匹配
- 支持转发结果的缓存机制

## 11. 路径匹配问题分析

### 11.1 当前路径匹配问题描述

**EARS语法描述：**
- **Ubiquitous**: 当前的RegisterHandlers函数中的路径匹配逻辑**必须**被分析以确认全路径匹配问题
- **State-driven**: 如果配置为全路径模式（full_path），**应该**匹配所有可能的请求路径
- **Unwanted behavior**: 当前实现**不能**正确匹配根路径"/"和某些子路径
- **Complex**: 当分析路径匹配问题时，**应该**确认：
  - go-zero框架的路径匹配规则
  - 通配符路径的具体行为
  - 前缀配置对路径匹配的影响

### 11.2 问题具体表现

在 [`internal/handler/routes.go`](internal/handler/routes.go:14) 文件中的 [`RegisterHandlers`](internal/handler/routes.go:14) 函数存在以下路径匹配问题：

1. **全路径模式下的路径匹配问题**：
   - 当前使用 `"/*path"` 作为路径模式（第34行和第68行）
   - 这种配置在go-zero框架中可能无法正确匹配根路径"/"
   - 对于某些特殊路径结构可能匹配失败

2. **前缀配置与路径匹配的冲突**：
   - 所有路由都配置了 `rest.WithPrefix("/codebase-indexer")` 前缀（第24行、第68行、第110行）
   - 这个前缀与路径模式结合可能导致实际匹配的路径不符合预期

3. **路径匹配逻辑的不一致性**：
   - 健康检查路由使用固定路径：`"/api/v1/proxy/health"`（第20行）
   - 全路径模式使用：`"/*path"`（第34行）
   - rewrite模式使用：`"/api/v1/proxy/*path"`（第76行）
   - 这种不一致性可能导致在某些情况下路径匹配失败

### 11.3 问题原因分析

1. **go-zero框架路径匹配机制**：
   - go-zero框架使用特定的路径匹配规则
   - `"/*path"` 通配符可能不包含根路径的匹配
   - 框架可能对通配符路径有特定的处理逻辑

2. **前缀与路径模式的组合问题**：
   - `rest.WithPrefix("/codebase-indexer")` 与 `"/*path"` 组合
   - 实际匹配的路径可能是：`"/codebase-indexer/*path"`
   - 这种组合可能导致某些路径无法正确匹配

3. **全路径模式的实现缺陷**：
   - 当前实现假设 `"/*path"` 可以匹配所有路径
   - 但实际上可能无法匹配根路径或某些特殊路径结构
   - 缺乏对路径匹配边界情况的充分测试

### 11.4 解决方案建议

1. **修改路径匹配模式**：
   - 考虑使用更明确的路径匹配规则
   - 可能需要为根路径添加专门的路由配置
   - 测试不同路径结构的匹配情况

2. **调整前缀配置**：
   - 评估是否需要前缀配置
   - 或者调整前缀与路径模式的组合方式
   - 确保前缀不会干扰路径匹配逻辑

3. **增强路径匹配测试**：
   - 添加针对各种路径结构的测试用例
   - 包括根路径、多级路径、特殊字符路径等
   - 确保全路径模式真正能够匹配所有可能的路径

### 11.5 验证标准

- [ ] 根路径"/"能够正确匹配和转发
- [ ] 多级路径如"/api/v1/users/123"能够正确匹配
- [ ] 包含查询参数的路径能够正确匹配
- [ ] 特殊字符路径能够正确匹配
- [ ] 空路径和边界情况能够正确处理
- [ ] 全路径模式与rewrite模式互不干扰